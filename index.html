<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>hello-wasm example</title>
</head>
<body>
<script src="index.js"></script>
<script type="module">
    import {hterm, lib} from "./hterm-all.js";

    let buffer = "";

    async function init_all() {
        // If you are a cross-browser web app and want to use window.localStorage.
        hterm.defaultStorage = new lib.Storage.Local();

        function setupHterm() {
            // profileId is the name of the terminal profile to load, or "default" if
            // not specified.  If you're using one of the persistent storage
            // implementations then this will scope all preferences read/writes to this
            // name.
            const t = new hterm.Terminal("profile-id");

            t.onTerminalReady = function () {
                // Create a new terminal IO object and give it the foreground.
                // (The default IO object just prints warning messages about unhandled
                // things to the the JS console.)
                const io = t.io.push();

                io.onVTKeystroke = io.sendString = (data) => {
                    //t.io.print(data);
                    console.log(data);
                    buffer = buffer + data;
                };

                io.onTerminalResize = (columns, rows) => {
                    // React to size changes here.
                    // Secure Shell pokes at NaCl, which eventually results in
                    // some ioctls on the host.
                };

                // You can call io.push() to foreground a fresh io context, which can
                // be uses to give control of the terminal to something else.  When that
                // thing is complete, should call io.pop() to restore control to the
                // previous io object.
            };

            t.decorate(document.querySelector('#terminal'));
            t.installKeyboard();

            t.io.print('$ ');

            return t;
        }

        // This will be whatever normal entry/initialization point your project uses.
        await lib.init();
        const terminal = setupHterm();

        let myWorker = new Worker('index.js');
        
        myWorker.onmessage = (event) => {
            const action = event.data[0];
            if (action === "buffer") {
                const lck = new Int32Array(event.data[1], 0, 1);
                const len = new Int32Array(event.data[1], 4, 1);
                if (buffer.length !== 0) {
                    console.log("got buffer request of len "+len[0]+", notifying");
                    const sbuf = new Uint16Array(event.data[1], 8, len[0]);
                    len[0] = (buffer.length > len[0]) ? len[0] : buffer.length;
                    console.log("current buffer is " + buffer + ", copying len " + len[0]);
                    for (let j = 0; j < len[0]; j++) {
                        sbuf[j] = buffer.charCodeAt(j);
                    }
                    buffer = buffer.slice(len[0], buffer.length);
                } else {
                    len[0] = 0;
                }
                lck[0] = 1;
                Atomics.notify(lck, 0);
            } else if (action === "stdout") {
                terminal.io.println(event.data[1]);
            } else if (action === "stderr") {
                console.log(event.data[1]);
            }
        }
        myWorker.postMessage("start");
    }

    window.onload = init_all;
</script>
<div id="terminal"></div>
</body>
</html>